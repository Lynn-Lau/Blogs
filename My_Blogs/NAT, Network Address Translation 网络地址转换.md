### NAT, Network Address Translation 网络地址转换

#### ABSTRACT

**NAT**（Network Address Translation，网络地址转换）是将IP 数据报报头中的IP 地址转换为另一个IP 地址的过程。在实际应用中，NAT 主要用于实现私有网络访问公共网络的功能。这种通过使用少量的公网IP 地址代表较多的私网IP 地址的方式，将有助于减缓可用IP 地址空间的枯竭。

#### INTRODUCTION

私网 IP 地址是指内部网络或主机的IP 地址，公网IP 地址是指在因特网上全球唯一的IP 地址。RFC 1918 为私有网络预留出了三个IP 地址块，如下：

* A类：10.0.0.0 ～ 10.255.255.255
* B类：172.16.0.0 ～ 172.31.255.255
* C类：192.168.0.0 ～ 192.168.255.255

上述三个范围内的地址不会在因特网上被分配，因此可以不必向ISP 或注册中心申请而在公司或企业内部自由使用。

NAT 最初的设计目的是用于实现私有网络访问公共网络的功能，后扩展到实现任意两个网络间进行访问时的地址转换应用，本文中将这两个网络分别称为内部网络（内网）和外部网络（外网），通常私网为内部网络，公网为外部网络。

下面介绍一个NAT的基本应用。

![NAT0](https://lynnlaulsl.files.wordpress.com/2016/11/nat_0.png)

通过上面的图中，我们可以看到地址转换的网络拓扑图，那么地址转换的具体过程如下：

1. 内网用户主机（192.168.1.3）向外网服务器（1.1.1.2）发送IP报文通过NAT设备；
2. NAT设备查看报头内容，发现该报文是发往外网的，将其源IP地址字段的私网地址192.168.1.3转换成为一个可以在以太网上选路的公网地址20.1.1.1，然后将该报文发送给外网的服务器，与此同时在NAT设备上网络设备转发表中记录这一IP地址的映射；
3. 外网服务器给内网用户发送应答报文（应答报文的IP地址是20.1.1.1），应答报文到达NAT设备之后，NAT设备查看报头内容，根据当前的网络地址转发表的记录，用内网的私有地址192.168.1.3替换应答报文的目的IP地址。

上述的 NAT 过程对终端（如图中的Host 和Server）来说是透明的。对外网服务器而言，它认为内网用户主机的IP 地址就是20.1.1.1，并不知道有192.168.1.3 这个地址。因此，NAT“隐藏”了企业的私有网络。

地址转换的优点在于，在为内部网络主机提供了“隐私”保护的前提下，实现了内部网络的主机通过该功能访问外部网络的资源。它也有一些缺点：

- 由于需要对数据报文进行 IP 地址的转换，涉及IP 地址的数据报文的报头不能被加密。在应用协议中，如果报文中有地址或端口需要转换，则报文不能被加密。例如，不能使用加密的FTP连接，否则FTP 协议的port 命令不能被正确转换。
- 网络调试变得更加困难。比如，某一台内部网络的主机试图攻击其它网络，则很难指出究竟哪一台主机是恶意的，因为主机的IP 地址被屏蔽了。

##### NAT的实现

###### 基本地址转换

从上面的图中我们可以看到，在地址的转换过程中，当内部网络访问外部网络的时候，地址转换将会选择一个合适外部地址来替代内部网络报文的源地址。在上图中我们选的是NAT设备的出接口的IP地址。这样的所有内部网络的主机访问外部网络的时候只能拥有一个外部网络的IP地址，因此，这种情况同时只允许最多有一部网络主机访问外部网络。

当内部网络的多台主机病的要求访问外部网络的时候，NAT也可以实现并发性请求的响应，允许NAT设备拥有多个公有的IP地址。当第一个内网主机访问外部网络时，NAT选择一个公有地址IP1，在地址转换表中添加记录并转发数据；当另一台主机访问外部网络的时候，NAT选择另一个公有的地址IP2，以此类推，从而满足了多台主的访问外部网络的请求。

> __NAT 设备拥有的公有IP 地址数目要远少于内部网络的主机数目，因为所有内网主机并不会同时访问外网。公有IP 地址的数目，应根据网络高峰期可能访问外网的内网主机数目的统计值来确定。__

###### NAPT

NAPT（Network Address Port Translation，网络地址端口转换）是基本地址转换的一种变形，它允许多个内部地址映射到同一个公有地址上，也可称之为“多对一地址转换”。

NAPT 同时映射IP 地址和端口号：来自不同内部地址的数据报文的源地址可以映射到同一外部地址，但它们的端口号被转换为该地址的不同端口号，因而仍然能够共享同一地址，也就是“私网IP 地址＋端口号”与“公网IP 地址＋端口号”之间的转换。下图描述了 NAPT 的基本原理。

![NAT1](https://lynnlaulsl.files.wordpress.com/2016/11/nat_efbc81.png)

如上图所示，三个带有内部地址的数据报文到达 NAT 设备，其中报文1 和报文2 来自同一个内部地址但有不同的源端口号，报文1 和报文3 来自不同的内部地址但具有相同的源端口号。通过NAPT映射，三个数据报文的源IP 地址都被转换到同一个外部地址，但每个数据报文都被赋予了不同的源端口号，因而仍保留了报文之间的区别。当各报文的回应报文到达时，NAT 设备仍能够根据回应报文的目的IP 地址和目的端口号来区别该报文应转发到的内部主机。

采用 NAPT 可以更加充分地利用IP 地址资源，实现更多内部网络主机对外部网络的同时访问。